name: ðŸš€ Optimized CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: 'false'
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'staging'
        type: choice
        options:
        - staging
        - production

# Global environment variables
env:
  NODE_VERSION: '18'
  CACHE_VERSION: v2
  FORCE_COLOR: 3

# Optimize workflow run time with concurrency controls
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================================================================
  # ðŸ” ANALYSIS & PREPARATION JOBS
  # ==================================================================
  
  prepare:
    name: ðŸ”§ Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      backend-cache-key: ${{ steps.cache-key.outputs.backend-key }}
      should-run-tests: ${{ steps.conditions.outputs.run-tests }}
      should-deploy: ${{ steps.conditions.outputs.deploy }}
      changed-files: ${{ steps.changes.outputs.files }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for better analysis

    - name: Detect Changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        filters: |
          frontend:
            - 'src/**'
            - 'public/**'
            - 'index.html'
            - 'vite.config.ts'
            - 'package*.json'
          backend:
            - 'backend/**'
          tests:
            - 'tests/**'
            - 'e2e/**'
            - '**/*.test.*'
            - '**/*.spec.*'
          config:
            - '.github/**'
            - 'tsconfig*.json'
            - 'vitest.config.*'
            - 'playwright.config.*'

    - name: Generate Cache Keys
      id: cache-key
      run: |
        echo "key=node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT
        echo "backend-key=backend-${{ env.CACHE_VERSION }}-${{ hashFiles('backend/package-lock.json') }}" >> $GITHUB_OUTPUT

    - name: Set Execution Conditions
      id: conditions
      run: |
        echo "run-tests=${{ github.event.inputs.skip_tests != 'true' && 'true' || 'false' }}" >> $GITHUB_OUTPUT
        echo "deploy=${{ github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}" >> $GITHUB_OUTPUT

    - name: Job Summary
      run: |
        echo "## ðŸ” Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Tests**: ${{ steps.conditions.outputs.run-tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Should Deploy**: ${{ steps.conditions.outputs.deploy }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Changes**: ${{ steps.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Changes**: ${{ steps.changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Changes**: ${{ steps.changes.outputs.tests }}" >> $GITHUB_STEP_SUMMARY

  # ==================================================================
  # ðŸ§ª TESTING JOBS (Parallel Execution)
  # ==================================================================

  frontend-tests:
    name: ðŸŽ¨ Frontend Testing Suite
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'
    
    strategy:
      matrix:
        test-group: [unit, integration, component]
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js with Caching
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Restore Dependencies Cache
      id: cache-deps
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          ~/.cache/npm
        key: ${{ needs.prepare.outputs.cache-key }}
        restore-keys: |
          node-${{ env.CACHE_VERSION }}-

    - name: Install Dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        npm ci --prefer-offline --no-audit
        echo "âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY

    - name: Run ESLint
      if: matrix.test-group == 'unit'
      run: |
        npm run lint -- --format=github
        echo "âœ… Linting completed" >> $GITHUB_STEP_SUMMARY

    - name: Type Check
      if: matrix.test-group == 'unit'
      run: |
        npx tsc --noEmit
        echo "âœ… Type checking completed" >> $GITHUB_STEP_SUMMARY

    - name: Run Tests (${{ matrix.test-group }})
      run: |
        case "${{ matrix.test-group }}" in
          unit)
            npm run test:run -- --coverage --reporter=verbose --reporter=github-actions
            ;;
          integration)
            npm run test:run -- tests/integration --reporter=verbose
            ;;
          component)
            npm run test:run -- src/components --coverage --reporter=verbose
            ;;
        esac

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-test-results-${{ matrix.test-group }}
        path: |
          coverage/
          test-results/
        retention-days: 7

    - name: Upload Coverage to Codecov
      if: matrix.test-group == 'unit'
      uses: codecov/codecov-action@v4
      with:
        directory: ./coverage
        flags: frontend
        name: frontend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}

  backend-tests:
    name: ðŸ”§ Backend Testing Suite
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'
    
    strategy:
      matrix:
        test-group: [unit, integration, api]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js with Caching
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Restore Backend Dependencies Cache
      id: cache-backend-deps
      uses: actions/cache@v3
      with:
        path: |
          backend/node_modules
          ~/.cache/npm
        key: ${{ needs.prepare.outputs.backend-cache-key }}
        restore-keys: |
          backend-${{ env.CACHE_VERSION }}-

    - name: Install Backend Dependencies
      if: steps.cache-backend-deps.outputs.cache-hit != 'true'
      working-directory: ./backend
      run: |
        npm ci --prefer-offline --no-audit
        echo "âœ… Backend dependencies installed" >> $GITHUB_STEP_SUMMARY

    - name: Cache Prisma Client
      uses: actions/cache@v3
      with:
        path: backend/node_modules/.prisma
        key: prisma-${{ hashFiles('backend/prisma/schema.prisma') }}

    - name: Setup Test Database
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379
      run: |
        npx prisma generate
        npx prisma db push --skip-generate
        echo "âœ… Test database setup completed" >> $GITHUB_STEP_SUMMARY

    - name: Run Backend Tests (${{ matrix.test-group }})
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-super-secure-key-for-testing
        SESSION_SECRET: test-session-secret-super-secure-key-for-testing
      run: |
        case "${{ matrix.test-group }}" in
          unit)
            npm run test:unit -- --coverage --reporter=verbose
            ;;
          integration)
            npm run test:integration -- --reporter=verbose
            ;;
          api)
            npm run test:api -- --reporter=verbose
            ;;
        esac

    - name: Upload Backend Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results-${{ matrix.test-group }}
        path: |
          backend/coverage/
          backend/test-results/
        retention-days: 7

    - name: Upload Backend Coverage
      if: matrix.test-group == 'unit'
      uses: codecov/codecov-action@v4
      with:
        directory: ./backend/coverage
        flags: backend
        name: backend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}

  api-integration-tests:
    name: ðŸ”— API Integration Tests  
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci --prefer-offline

    - name: Start Backend Server
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        NODE_ENV: test
        PORT: 3001
      run: |
        npm ci --prefer-offline
        npx prisma generate
        npx prisma db push
        npm run dev &
        sleep 15
        curl -f http://localhost:3001/api/health || exit 1

    - name: Run API Integration Tests
      run: |
        npm run test:api
        echo "âœ… API integration tests completed" >> $GITHUB_STEP_SUMMARY

    - name: Upload API Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: test-results/
        retention-days: 7

  e2e-tests:
    name: ðŸŽ­ End-to-End Tests
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/3, 2/3, 3/3]
      fail-fast: false

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user  
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: |
        npm ci --prefer-offline
        cd backend && npm ci --prefer-offline

    - name: Install Playwright Browsers
      run: |
        npx playwright install --with-deps ${{ matrix.browser }}

    - name: Cache Playwright Browsers
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}

    - name: Setup Test Environment
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        NODE_ENV: test
        PORT: 3001
      run: |
        npx prisma generate
        npx prisma db push
        npm run dev &
        sleep 20

    - name: Build and Start Frontend
      run: |
        npm run build
        npm run preview &
        sleep 10

    - name: Wait for Services
      run: |
        npx wait-on http://localhost:3001/api/health
        npx wait-on http://localhost:4173

    - name: Run E2E Tests
      run: |
        npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }}
      env:
        E2E_BASE_URL: http://localhost:4173

    - name: Upload E2E Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-results-${{ matrix.browser }}-${{ strategy.job-index }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7

  # ==================================================================
  # ðŸ” CODE QUALITY & SECURITY JOBS
  # ==================================================================

  code-quality:
    name: ðŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    needs: prepare

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci --prefer-offline

    - name: Run ESLint with SARIF Output
      run: |
        npm run lint -- --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
      continue-on-error: true

    - name: Upload ESLint SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: eslint-results.sarif

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: Check Bundle Size
      run: |
        npm run build
        npx bundlesize
      env:
        CI: true

  security-scan:
    name: ðŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    needs: prepare

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run npm audit
      run: |
        echo "## ðŸ›¡ï¸ NPM Audit Results" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=moderate --json > audit-results.json || true
        npx audit-ci --config .audit-ci.json
        echo "Frontend audit completed" >> $GITHUB_STEP_SUMMARY
        
        cd backend
        npm audit --audit-level=moderate --json > audit-results.json || true
        npx audit-ci --config ../.audit-ci.json
        echo "Backend audit completed" >> $GITHUB_STEP_SUMMARY

    - name: CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        languages: javascript

  # ==================================================================
  # ðŸ“Š PERFORMANCE & ACCESSIBILITY TESTS
  # ==================================================================

  performance-tests:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: |
        npm ci --prefer-offline
        cd backend && npm ci --prefer-offline

    - name: Setup Test Environment
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        NODE_ENV: production
        PORT: 3001
      run: |
        npx prisma generate
        npx prisma db push
        npm run build
        npm run start &
        sleep 20

    - name: Build and Start Frontend
      run: |
        npm run build
        npm run preview &
        sleep 10

    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    - name: Run Artillery Load Tests
      working-directory: ./performance
      run: |
        npm install -g artillery@latest
        artillery run artillery.yml --output report.json
        artillery report report.json

    - name: Upload Performance Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          .lighthouseci/
          performance/report.json
          performance/report.html
        retention-days: 7

  accessibility-tests:
    name: â™¿ Accessibility Testing
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-run-tests == 'true'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci --prefer-offline

    - name: Build Application
      run: npm run build

    - name: Start Preview Server
      run: |
        npm run preview &
        sleep 10

    - name: Install Playwright
      run: npx playwright install --with-deps chromium

    - name: Run Accessibility Tests
      run: npm run test:e2e -- e2e/accessibility.spec.ts

    - name: Upload Accessibility Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-results
        path: |
          playwright-report/
          test-results/
        retention-days: 7

  # ==================================================================
  # ðŸ—ï¸ BUILD & DEPLOY JOBS
  # ==================================================================

  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: prepare

    strategy:
      matrix:
        target: [frontend, backend]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ matrix.target == 'backend' && 'backend/package-lock.json' || 'package-lock.json' }}

    - name: Install Dependencies
      working-directory: ${{ matrix.target == 'backend' && './backend' || '.' }}
      run: npm ci --prefer-offline

    - name: Build Application
      working-directory: ${{ matrix.target == 'backend' && './backend' || '.' }}
      run: |
        if [ "${{ matrix.target }}" = "frontend" ]; then
          npm run build
          echo "Frontend build size:" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY
        else
          npm run build || echo "Backend build completed with warnings"
          echo "Backend build completed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target }}-build
        path: ${{ matrix.target == 'backend' && 'backend/dist' || 'dist' }}
        retention-days: 7

  # ==================================================================
  # ðŸš¦ QUALITY GATE & REPORTING
  # ==================================================================

  quality-gate:
    name: ðŸš¦ Quality Gate Analysis
    runs-on: ubuntu-latest
    needs: [
      frontend-tests, 
      backend-tests, 
      api-integration-tests,
      e2e-tests, 
      code-quality, 
      security-scan, 
      performance-tests,
      accessibility-tests,
      build
    ]
    if: always()

    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4

    - name: Generate Quality Report
      run: |
        echo "# ðŸ“Š Quality Gate Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job results
        echo "## Job Results" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¨ Frontend Tests | ${{ needs.frontend-tests.result }} | ${{ needs.frontend-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”§ Backend Tests | ${{ needs.backend-tests.result }} | ${{ needs.backend-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”— API Tests | ${{ needs.api-integration-tests.result }} | ${{ needs.api-integration-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ­ E2E Tests | ${{ needs.e2e-tests.result }} | ${{ needs.e2e-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š Code Quality | ${{ needs.code-quality.result }} | ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ›¡ï¸ Security | ${{ needs.security-scan.result }} | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ Performance | ${{ needs.performance-tests.result }} | ${{ needs.performance-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| â™¿ Accessibility | ${{ needs.accessibility-tests.result }} | ${{ needs.accessibility-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build | ${{ needs.build.result }} | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

    - name: Quality Gate Decision
      run: |
        # Critical failures that block deployment
        CRITICAL_JOBS=("${{ needs.frontend-tests.result }}" "${{ needs.backend-tests.result }}" "${{ needs.build.result }}")
        
        for result in "${CRITICAL_JOBS[@]}"; do
          if [[ "$result" != "success" ]]; then
            echo "âŒ Critical job failed: $result"
            exit 1
          fi
        done
        
        # Warning for non-critical failures
        if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
          echo "âš ï¸  E2E tests failed - deployment allowed but with warning"
        fi
        
        if [[ "${{ needs.performance-tests.result }}" != "success" ]]; then
          echo "âš ï¸  Performance tests failed - monitoring required"
        fi
        
        echo "âœ… Quality gate passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [quality-gate, prepare]
    if: needs.prepare.outputs.should-deploy == 'true' && needs.quality-gate.result == 'success'
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./dist

    - name: Deploy to ${{ github.event.inputs.environment || 'staging' }}
      run: |
        echo "ðŸš€ Deploying to ${{ github.event.inputs.environment || 'staging' }}"
        echo "Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
        
        # This is where you would add your actual deployment steps
        # Examples:
        # - Deploy to Vercel, Netlify, AWS, etc.
        # - Update Docker containers
        # - Run database migrations
        # - Update CDN cache

    - name: Post-Deployment Tests
      run: |
        echo "Running smoke tests on deployed application..."
        # Add smoke tests here
        echo "âœ… Smoke tests passed" >> $GITHUB_STEP_SUMMARY

  # ==================================================================
  # ðŸ“Š CLEANUP & NOTIFICATIONS
  # ==================================================================

  cleanup:
    name: ðŸ§¹ Cleanup & Notifications
    runs-on: ubuntu-latest
    needs: [quality-gate, deploy]
    if: always()

    steps:
    - name: Cleanup Old Artifacts
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          // Keep only the latest 5 artifacts for each type
          const artifactGroups = {};
          for (const artifact of artifacts.data.artifacts) {
            const type = artifact.name.split('-')[0];
            if (!artifactGroups[type]) artifactGroups[type] = [];
            artifactGroups[type].push(artifact);
          }
          
          for (const [type, groupArtifacts] of Object.entries(artifactGroups)) {
            if (groupArtifacts.length > 5) {
              const oldArtifacts = groupArtifacts.slice(5);
              for (const artifact of oldArtifacts) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }
          }

    - name: Send Notifications
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          // Add notification logic here (Slack, Discord, email, etc.)
          console.log('Pipeline failed - notifications would be sent here');

    - name: Final Summary
      run: |
        echo "## ðŸŽ‰ Pipeline Execution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Duration**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Thank you for contributing to Olivia Gold! âœ¨" >> $GITHUB_STEP_SUMMARY